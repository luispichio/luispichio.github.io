<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>Buenas!<br> Comenzando una serie de artículos sobre el tema vamos con el efecto fuego.<br> Se trata probablemente del efecto mas simple, no por ello, menos llamativo.<br> No vamos a realizar una simulación, ya que una tarea compleja de dinámica de fluídos; Nos limitaremos a implementar un algoritmo simple, conocido y utilizado desde la vieja escuela.<br> <br></p> <div class="separator" style="clear: both; text-align: center;"> <iframe allowfullscreen="allowfullscreen" webkitallowfullscreen="webkitallowfullscreen" mozallowfullscreen="mozallowfullscreen" width="320" height="266" src="https://www.youtube.com/embed/xO2nrz89YaA?feature=player_embedded" frameborder="0"></iframe> </div> <p><br> La implementación será realizada en Java (NetBeans 8.0.02 + JDK 1.7) por su portabilidad, no así por su rendimiento.<br> El efecto es de tipo “generación de textura en tiempo real”. Se articularán las herramientas para poder reutilizar el presente ejemplo en futuros artículos (efectos de deformación, renderizado, etc).<br> <br> <b><span style="font-size: large;">A los bifes</span></b><br> <br> Para la generación del efecto haremos uso de un buffer de efecto (cálculo) y otro de imagen (representación)<br> A su vez, el buffer de efecto tendrá un doble buffer (copia), ya que algunos de los procesos son destructivos (suavizado, enfriamiento, convección).<br> <br></p> <div class="separator" style="clear: both; text-align: center;"> </div> <div class="separator" style="clear: both; text-align: center;"> </div> <div class="separator" style="clear: both; text-align: center;"> </div> <div class="separator" style="clear: both; text-align: center;"> <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEic5ey5775g1GS8vC6SaYp_-_FNv8Vq4vdGFbt_ydg93b9r7DrtHm3f9kas_tLIyVGjwi2S-Ne01qeMqh8iawPVuoGFFe4uGLyOar-Mqm3qWe-tePXdC5Wko9sxMXXHuMQwbkkIbDAHd-1r/s1600/fire_buffer.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" rel="external nofollow noopener" target="_blank"><img border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEic5ey5775g1GS8vC6SaYp_-_FNv8Vq4vdGFbt_ydg93b9r7DrtHm3f9kas_tLIyVGjwi2S-Ne01qeMqh8iawPVuoGFFe4uGLyOar-Mqm3qWe-tePXdC5Wko9sxMXXHuMQwbkkIbDAHd-1r/s1600/fire_buffer.png" height="76" width="400"></a> </div> <p><br> Cada elemento del buffer de efecto es una representación numérica de la intensidad del fuego en un punto del posterior volcado en pantalla.<br> A mayor valor numérico, fuego mas intenso (tendiendo a amarillo o blanco a nivel gráfico).<br> A la inversa, a menor valor numérico, menos intenso (tendiendo a rojo o negro a nivel gráfico).<br> A cada valor de intensidad se le asignará posteriormente un color (Paleta de colores).<br> <br> El buffer de imagen tendrá las dimensiones del efecto que se quiera representar.<br> En el ejemplo de 256 x 128 pixeles (32768 pixels).<br> El buffer de efecto será ligeramente mas grande: Un par de pixeles en altura (parte inferior) en donde se generará la ignición. Este sector no se transferirá el buffer de imagen (no será visible).<br> <br> <b>Paleta de colores</b><br> Probablemente el punto crítico del efecto.<br> Con la paleta adecuada, el efecto es casi siempre agradable a la vista.<br> La paleta incorrecta, no solo da aspecto de irreal (colores); También afecta la convección y altura del efecto.<br> <br></p> <div class="separator" style="clear: both; text-align: center;"> <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUKRkh2EqyjOFNKICyl7plgaARGPHSJynU0eSIUaX_9QvSkT7FGJnwfTjvVfHipNix9NfxdVrMf1PtpkgNNI_2D7xk1hGCpeA-ZYR4JgEJ9sYQVmZzVL0aM0VVeySKCG_YEDuDjNGjLFzq/s1600/paleta.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" rel="external nofollow noopener" target="_blank"><img border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUKRkh2EqyjOFNKICyl7plgaARGPHSJynU0eSIUaX_9QvSkT7FGJnwfTjvVfHipNix9NfxdVrMf1PtpkgNNI_2D7xk1hGCpeA-ZYR4JgEJ9sYQVmZzVL0aM0VVeySKCG_YEDuDjNGjLFzq/s1600/paleta.png" height="12" width="400"></a> </div> <p><br> Para el ejemplo utilizaremos una paleta de 112 colores<br> <br>   16 colores [0..15] -&gt; Negro a Rojo (menor intensidad)<br>   32 colores [16..47] -&gt; Rojo a Amarillo (pasando por naranja)<br>   32 colores [48..80] -&gt; Amarillo a Blanco<br>   32 colores [80..112] -&gt; Blancos (mayor intensidad)<br> <br> <b><span style="font-size: large;">Generación del efecto</span></b><br> <b><br></b> Para simplificar la explicación, vamos a dividir la generación del efecto en las siguientes etapas:<br>   (1) Ignición<br>   (2) Propagación de calor<br>   (3) Enfriamiento<br>   (4) Convección<br> <br> <b>(1) Ignición (generación de llama)</b><br> La generación de llama consiste en agregar puntos de calor (valores altos) al buffer de efecto de forma aleatoria y normalmente en la parte baja (fuego desde abajo hacia arriba).<br> En cada ciclo de animación refrescaremos un par de líneas en la parte inferior del buffer de efecto, que, por lo anteriormente comentado, no formará parte del área visible del efecto.<br> <br> <b>Pseudocódigo de ignición</b><br></p> <pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code style="color: black; word-wrap: normal;">para cada x
  buffer(x, 0) = numero_al_azar()
</code></pre> <p><b><br></b> <b>(2) Propagación de calor</b><br> La “magia” del efecto, es tan simple como un “suavizado” (smooth) del buffer de efectos.<br> Hay muchos tipos de “suavizado”, para el ejemplo utilizaremos el mas simple y eficiente: Media aritmética.<br> En cada ciclo de la animación, a cada punto lo reemplazaremos por la media aritmética de él y sus vecinos:<br> <br></p> <div class="separator" style="clear: both; text-align: center;"> <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHAoTWRrWD42w4LhQsfj7fLtLsATM9RNIwH1ajgFop3PuBljF0Sh6T28Ro_tXHKvCK7JA7p6DiDiRg94Fw4WXh4QrbAgmfv69_s8FkB_mtdNwXniAq7x4eobUe-5WDV8NQp2PznxMxeSiF/s1600/fire_buffer_frames.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" rel="external nofollow noopener" target="_blank"><img border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHAoTWRrWD42w4LhQsfj7fLtLsATM9RNIwH1ajgFop3PuBljF0Sh6T28Ro_tXHKvCK7JA7p6DiDiRg94Fw4WXh4QrbAgmfv69_s8FkB_mtdNwXniAq7x4eobUe-5WDV8NQp2PznxMxeSiF/s1600/fire_buffer_frames.png" height="76" width="400"></a> </div> <p><br> <b>Pseudocódigo de propagación del calor</b><br></p> <pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code style="color: black; word-wrap: normal;">para cada x, y
  buffer(x, y) = (
    buffer(x, y) +
    buffer(x + 1, y) +
    buffer(x - 1, y) +
    buffer(x, y + 1) +
    buffer(x + 1, y - 1)
  ) / 5
</code></pre> <p><b><br></b> <b>(3) Enfriamiento</b><br> La técnica consiste restar un valor aleatorio a cada elemento del buffer de efectos.<br> Lo de “valor aleatorio” es relativo; Utilizaremos una máscara (otro buffer) generada a partir de valores aleatorios, lo que contribuirá de manera significativa al rendimiento por no tener que generar valores en tiempo real.<br> Con una paleta estándar, al “restar” estamos oscureciendo o quitando intensidad al fuego en ese sector.<br> La finalidad es darle mas dinámica al efecto (movimiento), favorecer la convección, darle aspecto aleatorio a el efecto, etc.<br> <br> <b>Pseudocódigo de enfriamiento</b><br></p> <pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code style="color: black; word-wrap: normal;">para cada x, y
  buffer(x, y) = buffer(x, y) - buffer_enfriamiento(x, y)
    si buffer(x, y) &lt; 0
      buffer(x, y) = 0
</code></pre> <p><br> Utilizaremos una máscara de enfriamiento (buffer circular simétrico) generada a partir de un relleno al azar suavizado, lo que le conferirá homogeneidad.<br> <br></p> <div class="separator" style="clear: both; text-align: center;"> <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgYbG4T9xZxguD-oWLLV-8w2A6D1-H4gGioTkDe17gL34IgDB8aW3t-Y0VMNEvYzu_gcIwW8n8_IQ4sKLhoei9JL2Jd9raIlZyi4E35NgwmBXuTTxLSrnKKy7nyoVFq6wLD4kTkgqTh1PTD/s1600/cooling_buffer.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" rel="external nofollow noopener" target="_blank"><img border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgYbG4T9xZxguD-oWLLV-8w2A6D1-H4gGioTkDe17gL34IgDB8aW3t-Y0VMNEvYzu_gcIwW8n8_IQ4sKLhoei9JL2Jd9raIlZyi4E35NgwmBXuTTxLSrnKKy7nyoVFq6wLD4kTkgqTh1PTD/s1600/cooling_buffer.png" height="110" width="400"></a> </div> <p><br> Ciclo a ciclo de la animación haremos un scroll ascendente a la máscara, lo que favorecerá la convección.<br></p> <div> <br> </div> <p><b>Pseudocódigo de generación de mapa de enfriamiento</b><br></p> <pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code style="color: black; word-wrap: normal;">//relleno al azar
para cada x, y
  buffer_enfriamiento(x, y) = numero_al_azar()

//suavizado
repetir 20
  para cada x, y
    buffer_enfriamiento(x, y) = (
      buffer_enfriamiento(x, y) +
      buffer_enfriamiento(x + 1, y) +
      buffer_enfriamiento(x - 1, y) +
      buffer_enfriamiento(x, y + 1) +
      buffer_enfriamiento(x, y - 1)
    ) / 5
</code></pre> <p><b><br></b></p> <p><b>(4) Convección</b><br> Tiene la finalidad de darle “aspecto ascendente” a  nuestras llamas.<br> En cada ciclo de animación, haremos un scroll ascendente de 1 o 2 líneas sobre el buffer de efecto.<br> <br> <b>Código fuente / binarios compilados</b><br> <br></p> <ul> <li>Código fuente - Clase Fuego: <a href="https://drive.google.com/file/d/0B0iOjodlf4ReTU9XTTk5UjZrN00/view?usp=sharing" rel="external nofollow noopener" target="_blank">Fuego.java</a> </li> <li>Aplicación compilada: <a href="https://drive.google.com/file/d/0B0iOjodlf4ReNGdjY25pbHRkNU0/view?usp=sharing" rel="external nofollow noopener" target="_blank">Fuego.jar</a> </li> <li>Proyecto de NetBeans (8.0.2): <a href="https://drive.google.com/file/d/0B0iOjodlf4ReSHRlWDF6dkZiWm8/view?usp=sharing" rel="external nofollow noopener" target="_blank">Fuego.zip</a> </li> </ul> <p><br> <b>Observaciones</b><br>   Por cuestiones de rendimiento y compatibilidad no se utilizarán vectores de dos dimensiones, en su lugar usaremos vectores unidimensionales.<br>   Se hará uso de un único tipo de entero (entero de 32bits con signo) por no detectarse variaciones significativas en el rendimiento y complicarse la implementación y legibilidad del código (casteos, control de desbordes, etc).<br> <br> <b>Variaciones del efecto</b><br>   Controlando la ignición es posible lograr variaciones vistosas del efecto.<br>   Propongo al lector en lugar de generar ignición en la parte baja del efecto, utilizar máscaras con texto, formas geométricas, gráfica, máscaras animadas (bolas de fuego), etc.<br> <br> Doy por terminado este primer artículo, espero el contenido haya sido de utilidad.<br> Cualquier duda no duden en consultar, nos vemos en la siguiente entrada.<br> Saludos, Luis.-</p> </body></html>